/*!
 Simple JavaScript Templating originally by John Resig:
 http://ejohn.org/blog/javascript-micro-templating/
 Modified by Rick Strahl:
 http://west-wind.com/weblog/posts/2008/Oct/13/Client-Templating-with-jQuery
 MIT Licensed
*/
(function(){var b={};this.tmpl=function a(e,d){var c=!/\W/.test(e)?b[e]=b[e]||a(document.getElementById(e).innerHTML):new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+e.replace(/[\r\t\n]/g," ").replace(/'(?=[^%]*%>)/g,"\t").split("'").join("\\'").split("\t").join("'").replace(/<%=(.+?)%>/g,"',$1,'").split("<%").join("');").split("%>").join("p.push('")+"');}return p.join('');");return d?c(d):c}})();
/*!
	Stack View - The jQuery virtual stack plugin
	by The Harvard Library Innovation Lab
	
	Dual licensed under MIT and GPL.
*/
(function(b,e,f,a){var i,c="stackView",g,h={},d={};i={init:"stackview.init",item_added:"stackview.itemadded",item_removed:"stackview.itemremoved",page_load:"stackview.pageload"};h.get_type=function(k){var j;b.each(d,function(l,m){if(m.match(k)){j=m;return false}});return j};h.render_items=function(j,n,k){var l=k?"before":"append",m=k?k:j.$element.find(j.options.selectors.item_list);b.each(n,function(p,r){var q=h.get_type(r),o;if(q==null){return true}o=b(tmpl(q.template,q.adapter(r,j.options)));o.data("stackviewItem",r);m[l](o)});if(k){k.remove()}};h.calculate_params=function(j){var k=j.options,l;l={start:j.page*j.options.items_per_page,limit:j.options.items_per_page,search_type:j.options.search_type,query:j.options.query};if(l.search_type==="loc_sort_order"){l.start=0;if(j.page===0){j.loc={low:k.id-Math.floor(k.items_per_page/2),high:k.id+Math.floor(k.items_per_page/2)};l.query=["[",j.loc.low,"%20TO%20",j.loc.high,"]"].join("")}else{if(j.direction==="down"){l.query=["[",j.loc.high+1,"%20TO%20",j.loc.high+k.items_per_page+1,"]"].join("");j.loc.high=j.loc.high+k.items_per_page+1}else{if(j.direction==="up"){l.query=["[",j.loc.low-k.items_per_page-1,"%20TO%20",j.loc.low-1,"]"].join("");j.loc.low=j.loc.low-k.items_per_page-1}}}}return l};h.fetch_page=function(k,n){var m=h.calculate_params(k),j=b.param(m),l;k.page++;l=e.stackCache.get(k.options.url+j);if(l){n(l)}else{b.ajax({url:k.options.url,data:j,dataType:k.options.jsonp?"jsonp":"json",success:function(o){e.stackCache.set(k.options.url+m,o,k.options.cache_ttl);n(o)}})}};g=function(k,j){this.element=k;this.$element=b(k);this.options=b.extend({},g.defaults,j);this.page=0;this.finished={up:false,down:false};this.loc={low:null,high:null};this.direction="down";this.init()};b.extend(g,{defaults:{cache_ttl:60,data:"",id:null,items_per_page:10,jsonp:false,query:"",ribbon:"Stack View",search_type:"keyword",selectors:{item:".stack-item",item_list:".stack-items",ribbon:".ribbon"},url:"basic.json"},registerType:function(j){d[j.name]=j}});b.extend(true,g.prototype,{init:function(){var j=this;this.$element.html(tmpl(g.templates.scaffold,{ribbon:this.options.ribbon})).addClass("stackview").bind(i.page_load,function(){j.zIndex()});this.$element.data("stackviewObject",this);this.$element.trigger(i.init);this.next_page()},next_page:function(){var j=b(tmpl(g.templates.placeholder,{})),l=this,k=this.options;if(this.finished.down){return}this.direction="down";if(k.data){h.render_items(this,k.data.docs?k.data.docs:k.data);this.finished.down=true;this.$element.trigger(i.page_load,[k.data])}else{if(k.url){this.$element.find(k.selectors.item_list).append(j);h.fetch_page(this,function(m){h.render_items(l,m.docs,j);if(parseInt(m.start,10)===-1){l.finished.down=true}l.$element.trigger(i.page_load,[m])})}}},prev_page:function(){var j=b(tmpl(g.templates.placeholder,{})),l=this.options,k=this,m=k.$element.find(l.selectors.item).first();if(l.search_type!=="loc_sort_order"||this.finished.up){return}this.direction="up";this.$element.find(l.selectors.item_list).prepend(j);h.fetch_page(this,function(o){var n=m.position().top;h.render_items(k,o.docs,j);if(k.page>1){k.$element.find(l.selectors.item_list).animate({scrollTop:"+="+(m.position().top-n)},0)}if(parseInt(o.start,10)===-1){k.finished.up=true}k.$element.trigger(i.page_load,[o])})},add:function(){var p=this.$element.find(this.options.selectors.item),k,m,l,n,o,j;if(typeof(arguments[0])==="number"){k=arguments[0];m=arguments[1]}else{k=p.length;m=arguments[0]}if(k>p.length||k<0){return}else{if(k===p.length){o=p.last();n="after"}else{o=p.eq(k);n="before"}}l=h.get_type(m);if(l==null){return}j=b(tmpl(l.template,l.adapter(m,this.options)));j.data("stackviewItem",m);o[n](j);this.zIndex();this.$element.trigger(i.item_added)},remove:function(j){var n=this.$element.find(this.options.selectors.item),l,m,k;if(typeof(j)==="number"){l=n.eq(j)}else{if(j.nodeType||j.jquery){l=b(j)}else{n.each(function(p,q){var o=b(q);if(o.data("stackviewItem")===j){l=o;return false}})}}if(l==null||!l.length){return}l.detach();m=l.data("stackviewItem");this.$element.trigger(i.item_removed,[m]);return l},getData:function(){var j=[];this.$element.find(this.options.selectors.item).each(function(){j.push(b(this).data("stackviewItem"))});return j},zIndex:function(j){var n=this.$element.find(this.options.selectors.item),l=n.length,k=0,m=j?0:n.length-1;while(k<l){n.eq(k).css("z-index",m);m=m+(j?1:-1);k++}}});b.fn[c]=function(l){var j,k=Array.prototype.slice.call(arguments,1);this.each(function(n,p){var m=b(p),q=m.data("stackviewObject");if(!q){new g(p,l)}else{if(q[l]){var o=q[l].apply(q,k);if(j===a&&o!==a){j=o}}}});return j===a?this:j};e.StackView=g})(jQuery,window,document);(function(c,d){var a=c(document),b;c.extend(StackView.defaults,{infiniteScrollDistance:100});b=function(f){var l=c(f.target),m=l.data("stackviewObject"),e=m.options,g,k,e,h,j,i;g=l.find(e.selectors.item_list);k=l.find(e.selectors.item);h=k.length?k.last().position().top:0;h+=g.scrollTop();j=h-l.height()-e.infiniteScrollDistance;i=function(){if(e.search_type==="loc_sort_order"&&g.scrollTop()<=e.infiniteScrollDistance){g.unbind("scroll.stackview");l.stackView("prev_page")}else{if(g.scrollTop()>=j){g.unbind("scroll.stackview");l.stackView("next_page")}}};g.bind("scroll.stackview",i);i()};a.delegate(".stackview","stackview.pageload",b)})(jQuery);(function(c,d){var b=c(document),a=window.StackView;c.extend(true,a.defaults,{transitionDuration:200,navigationPercent:80,selectors:{downstream:".downstream",upstream:".upstream",num_items:".num-found span"}});b.delegate(".stackview","stackview.init",function(f){var g=c(f.target),e=g.data("stackviewObject"),i=g.find(e.options.selectors.item_list),h=g.height()*e.options.navigationPercent/100;e.num_found_delta=0;g.prepend(tmpl(a.templates.navigation,{empty:e.options.search_type==="loc_sort_order"}));g.delegate(e.options.selectors.downstream,"click",function(){i.animate({scrollTop:"+="+h},e.options.transitionDuration);return false}).delegate(e.options.selectors.upstream,"click",function(){i.animate({scrollTop:"-="+h},e.options.transitionDuration);return false})}).delegate(".stackview","stackview.pageload",function(h,i){var j=c(h.target),e=j.data("stackviewObject"),g=i.num_found?parseInt(i.num_found,10):i.length,f;e.num_found=g;f=g+e.num_found_delta;j.find(e.options.selectors.num_items).text(f)}).delegate(".stackview","stackview.itemadded stackview.itemremoved",function(g){var h=c(g.target),e=h.data("stackviewObject"),i=h.find(e.options.selectors.item),f;e.num_found_delta+=(g.namespace==="itemadded"?1:-1);f=e.num_found+e.num_found_delta;h.find(e.options.selectors.num_items).text(f)})})(jQuery);window.stackCache=(function(d,f){var b={},e=d.JSON&&(function(){try{return("localStorage" in d)&&d.localStorage!==null}catch(h){return false}})();return{set:g,get:c,remove:a};function g(j,k,h){var i=h&&new Date(+new Date()+h*1000),m={expires:+i,value:k};if(e){try{localStorage[j]=JSON.stringify(m)}catch(l){return l}}else{b[j]=m}}function c(h){var i,j;if(e){i=localStorage[h];if(i){i=JSON.parse(i)}}else{i=b[h]}if(i){if(i.expires&&i.expires<+new Date()){a(h)}else{j=i.value}}return j}function a(h){if(e){localStorage.removeItem(h)}else{delete b[h]}}})(window);(function(a){StackView.templates={scaffold:'			<div class="ribbon"><%= ribbon %></div>			<ul class="stack-items" />',navigation:'			<div class="stack-navigation<%= empty ? " empty" : ""%>">				<div class="upstream">Up</div>				<div class="num-found">					<span></span><br />items				</div>				<div class="downstream">Down</div>			</div>',book:'			<li class="stack-item stack-book heat<%= heat %>" style="width:<%= book_height %>; height:<%= book_thickness %>;">				<a href="<%= link %>" target="_newtab">					<span class="spine-text">						<span class="spine-title"><%= title %></span>						<span class="spine-author"><%= author %></span>					</span>					<span class="spine-year"><%= year %></span>					<span class="stack-pages" />					<span class="stack-cover" />				</a>			</li>',placeholder:'<li class="stackview-placeholder"></li>'}})();(function(f,h,c){f.extend(true,h.StackView.defaults,{book:{max_height_percentage:100,max_height:39,max_pages:540,min_height_percentage:59,min_height:20,min_pages:200,page_multiple:0.2}});var d=function(o,n,k,l,q){var j=k-n,m=q-l,p=(o-n)/(j);return l+p*m};var g=function(j){return j===100?10:Math.floor(j/10)+1};var i=function(m,l){var k=parseInt(l.measurement_height_numeric,10),n=m.book.min_height,j=m.book.max_height;if(isNaN(k)){k=n}k=Math.min(Math.max(k,n),j);k=d(k,m.book.min_height,m.book.max_height,m.book.min_height_percentage,m.book.max_height_percentage);return k+"%"};var e=function(m,l){var o=parseInt(l.measurement_page_numeric,10),n=m.book.min_pages,k=m.book.max_pages,j=m.book.page_multiple;if(isNaN(o)){o=n}o=Math.min(Math.max(o,n),k)*j;return o+"px"};var b=function(j){return j.title_link_friendly?"../shelflife/book/"+j.title_link_friendly+"/"+j.id:j.link};var a=function(k){var j=k.creator&&k.creator.length?k.creator[0]:"";if(/^([^,]*)/.test(j)){j=j.match(/^[^,]*/)}return j};h.StackView.registerType({name:"book",match:function(j){return j.pub_date&&j.title&&j.creator},adapter:function(k,j){return{heat:g(k.shelfrank),book_height:i(j,k),book_thickness:e(j,k),link:b(k),title:k.title,author:a(k),year:k.pub_date}},template:'			<li class="stack-item stack-book heat<%= heat %>" style="width:<%= book_height %>; height:<%= book_thickness %>;">				<a href="<%= link %>" target="_newtab">					<span class="spine-text">						<span class="spine-title"><%= title %></span>						<span class="spine-author"><%= author %></span>					</span>					<span class="spine-year"><%= year %></span>					<span class="stack-pages" />					<span class="stack-cover" />				</a>			</li>'})})(jQuery,window);